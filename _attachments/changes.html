<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>Cloudant/CouchDB Changes Listener</title>
    <link href="//cloudant.com/wp-content/themes/cloudant/images/favicon.ico" rel='shortcut icon' type='image/vnd.microsoft.icon' />
    <link href="//cloudant.com/wp-content/themes/cloudant/images/favicon.png" rel='icon' type='image/png' />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	</head>
	<body>
		<div class="container">
      
      <div class="page-header">
        <h1>Cloudant/CouchDB Changes Listener</h1>
      </div>
    
    <div class="row">
      <div class="col-sm-12">
        <form class="form" onsubmit="return false">
          <div class="form-group">
            <label for="searchterm">Database https://itselezvorgatterstiongen:lQyjxkwFB2HN60oNce21VaRF@rajsingh.cloudant.com/fieldedits</label>
            <input type="text" class="form-control" id="q" placeholder="https://$username:$pw@$username.cloudant.com/$databasename">
          </div>
          <button class="btn btn-primary" onclick="listen()">Listen</button>
          &nbsp; <span id="searchtime"></span>
        </form>
        <p>&nbsp;</p><p>&nbsp;</p>
      </div><!-- end column -->
    </div><!-- end row -->

    <div class="row">
      <div class="col-sm-12">
        <div class="panel panel-warning">
          <div class="panel-heading">
            <h3 class="panel-title">Responses</h3>
          </div>
          <div class="panel-body" id="messages" style="height:200px;overflow:scroll"></div>
        </div>      
      </div><!-- end column -->
    </div><!-- end row -->

    </div><!-- top div -->

		<script src="js/jquery-1.11.1.min.js"></script>
		<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		<script src="js/pouchdb-4.0.0.min.js"></script>
    <script>
    var changedb;
    var localdb = new PouchDB('changetest');
    localdb.info().then(function (info) {
      sendMessage('Local database: ' + JSON.stringify(info));
    });
    
    function listen() {
      var u = $('#q').val();
      changedb = new PouchDB(u);
      // sendMessage(u);
      
      var sync = localdb.sync(changedb, {live:true,retry:true})
    	.on('change', function (info) {
    		sendMessage(info);
    	}).on('paused', function () {
    		sendMessage("Replication paused");
    	}).on('active', function () {
    		sendMessage("Active Replication...");
    	}).on('complete', function (info) {
          sendMessage(info);
      }).on('denied', function (info) {
        sendMessage(info);
    	}).on('error', function (err) {
    		sendMessage(err);
    	});
    }
    
    function sendMessage(str) {
      if (typeof str == 'object' ) str = JSON.stringify(str);
      var m = $('#messages');
      m.html( m.html() + '<hr>' + str + '<br/>' );
      m.scrollTop = m.scrollHeight+1000;
    }
    </script>
	</body>
</html>
